# Tuning suitable for a Satellite with 256G of RAM
#
# Instructions for use:
# 1) Copy this file to /etc/foreman-installer/custom-hiera.yaml
# 2) run 'satellite-installer' with no arguments to apply these settings

apache::mod::passenger::passenger_max_pool_size: 240
apache::mod::passenger::passenger_max_request_queue_size: 1000
apache::mod::passenger::passenger_max_requests: 1000

apache::mod::prefork::serverlimit: 1024
apache::mod::prefork::maxclients: 1024
apache::mod::prefork::maxrequestsperchild: 4000

qpid::open_file_limit: 65536
qpid::router::open_file_limit: 150100

puppet::server::puppetserver::jvm_min_heap_size: 2G
puppet::server::puppetserver::jvm_max_heap_size: 8G
puppet::server::puppetserver::server_max_active_instances: 32
puppet::server::puppetserver::server_max_requests_per_instance: 100000

candlepin::java_opts: "-Xms1024m -Xmx8192m"

postgresql::server::config_entries:
  max_connections: 1000
  shared_buffers: 32GB
  work_mem: 8MB
  checkpoint_segments: 32
  checkpoint_completion_target: 0.9
  effective_cache_size: 32GB
  autovacuum_vacuum_cost_limit: 2000
  log_min_duration_statement: 500


# Manual configurations recommended:
#
# 1) General performance and throughput can be increased at scale when you add an
# additional dynflow_executor process This is not managed yet by
# satellite-installer, see: https://bugzilla.redhat.com/show_bug.cgi?id=1692535
#
# Recommended settings:
# 32-64G RAM: 2
# 65G-128G RAM or more: 3
#
# Edit: /etc/sysconfig/dynflowd
# EXECUTORS_COUNT=2
#
# Additionally memory consumption is better controlled when adding the below tuning
# paramter to /etc/sysconfig/dynflowd
# MALLOC_ARENA_MAX=2
#
# These changes require a restart of 'foreman-tasks' service.
#
# 2) Set max open files for httpd. The installer does not yet provide tuning for this
#    see : https://bugzilla.redhat.com/show_bug.cgi?id=1728420
#
#  mkdir -p  /etc/systemd/system/httpd.service.d/
#  echo "[Service]" >> /etc/systemd/system/httpd.service.d/limits.conf
#  echo "LimitNOFILE=640000" >> /etc/systemd/system/httpd.service.d/limits.conf
#  systemctl daemon-reload
#  foreman-maintain service restart
#
# 3) For conditions that require above a 256 PassengerMaxPoolSize you need to tune
# the kernel:
#
# echo "kernel.sem= 250 256000 32 16384" > /etc/sysctl.d/01-satellite-tune.conf
# echo "fs.aio-max-nr = 1000000" >> /etc/sysctl.d/01-satellite-tune.conf
# sysctl -p /etc/sysctl.d/01-satellite-tune.conf
